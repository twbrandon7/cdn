<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta content="zh-tw" http-equiv="Content-Language" />
<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
<title>匯款登記表單</title>
<!--JQuery-->
<script src="./js/jquery-3.1.1.min.js"></script>

<!--uikit-->
<!--<link rel="stylesheet" href="./hac/uikit/css/uikit.docs.min.css" />-->
<link rel="stylesheet" href="./uikit/css/uikit.almost-flat.min.css" />
<script src="./uikit/js/uikit.min.js"></script>

<!--custom css-->
<link rel="stylesheet" href="./css/style.css" />
<link rel="stylesheet" href="./css/table.css" />

<!--button-->
<link rel="stylesheet" href="./css/button/css/buttons.css">
<script type="text/javascript" src="./css/button/js/buttons.js"></script>

<!--icheck-->
<link href="./icheck/skins/square/red.css" rel="stylesheet">
<script src="./icheck/icheck.js"></script>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>

<span id="show" style="text-align: center; font-size: 200%; display:none;">
	<span class="loading-use-flexbox"><div class="loadingImg"></div></span>
	<p>請稍候...</p>
</span>

<span id="show_success" style="text-align: center; font-size: 22pt; line-height: 24pt; display:none;">
	<span class="loading-use-flexbox"><div class="hacLogoImg"></div></span>
	<p>系統已為您補上報名序號 <span id="signInId" style="color:red;"></span> 之匯款資料!</p>
	<p>建議您至本網站「<a href="https://sites.google.com/site/tccdjsbc/sign-in-status" target="_blank">查詢報名狀態</a>」頁面確認您隊伍的報名狀態。</p>
	<br/>
	<p>報名表也已為您更新，建議您下載補齊匯款資料的報名表作為備份。</p>
	<p>
		<a href="#" target="_blank" class="button button-rounded button-flat-caution" id="download"><i class="uk-icon-cloud-download"></i> 下載pdf檔報名表</a>
		<a href="#" target="_blank" class="button button-rounded button-flat-caution" id="view"><i class="uk-icon-google"></i> 在Google雲端硬碟中開啟</a>
	</p>
</span>

<span id="show_done_before" style="text-align: center; font-size: 22pt; line-height: 24pt; display:none;">
	<span class="loading-use-flexbox"><div class="hacLogoImg"></div></span>
	<p>報名序號 <span id="signInId" style="color:red;"></span> 之匯款資料已在先前填寫完畢，不需要再填寫!</p>
	<p>建議您至本網站「<a href="https://sites.google.com/site/tccdjsbc/sign-in-status" target="_blank">查詢報名狀態</a>」頁面確認您隊伍的報名狀態。</p>
</span>

<div id="cover" style="margin-top:20px;">
	<form id="toPost" name="toPost" action="" method="post" class="uk-form">
		<p><span id="notfound" style="color: rgb(219, 68, 55);display:none;">找不到您的隊伍資料，請確認您所輸入的網路報名序號是否正確!</span></p>
		
		<span style="color: rgb(219, 68, 55); font-family: Roboto, RobotoDraft, Helvetica, Arial, sans-serif; font-size: 15px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); display: inline !important; float: none;">
		*必填</span><br /><br />
		<span class="mustFill">* </span><span class="titleStyle">網路報名序號 : </span><br />
		<input name="id" id="id" type="text" class="uk-form-medium" /><br />
		<br />
		<span id="show_info" style="text-align: center; font-size:14pt; display:none;">
			<p style="text-align: center; font-size:20pt;margin-top:10px;">請確認球隊資訊!</p>
			<table style="width: 90%; margin-left:5%;margin-top:20px;line-height:16pt;" class="fancytable">
				<tr class="headerrow">
					<td style="width: 40%">資訊</td>
					<td>內容</td>
				</tr>
				<tr class="datarowodd">
					<td style="width: 40%">網路報名序號</td>
					<td id="signInId" style="color:red;">&nbsp;</td>
				</tr>
				<tr class="dataroweven">
					<td style="width: 40%">隊名</td>
					<td id="teamName">&nbsp;</td>
				</tr>
			</table>
		</span>
		<br/>
		<br/>
		<span id="transferNUMspan" style="display:none;">
			<span class="mustFill">* </span><span class="titleStyle">欲補填之匯款帳號後四碼 : </span><br />
			<input name="transferNUM" id="transferNUM" type="text" class="uk-form-medium" /><br />
			<br />
		</span>
		<div style="clear: left;"></div>
		<span name="newLine" id="newLine"></span>
		<!--<p style="text-align: center; visibility:hidden;"><input type="submit" value="提交" name="submit" id="post"></p>-->
	</form>
	<p style="text-align: center;" id="nextFrame"><button name="next" id="next" class="button button-rounded button-flat-primary">下一步</button></p>
	<br/>
	<br/>
	<span id="startToPost" style="display:none;margin-top:10px;">
		<p style="text-align: center;">
				<input name="aggree" type="checkbox" id="agree" value="0" />
				<span class="titleStyle" onclick="$('input#agree')[0].click();">
					我已填寫匯款帳號後四碼，並確認資料無誤。
				</span>
		</p>
		<p style="text-align: center;"><button name="submit" id="submit" disabled="true" class="button button-rounded button-flat-primary">送出</button></p>
	</span>
	
</div>
<div style="height:30;"></div>

<script language="javascript">
	function isValidEmailAddress(emailAddress) {
		var pattern = /^([a-z\d!#$%&'*+\-\/=?^_`{|}~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+(\.[a-z\d!#$%&'*+\-\/=?^_`{|}~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+)*|"((([ \t]*\r\n)?[ \t]+)?([\x01-\x08\x0b\x0c\x0e-\x1f\x7f\x21\x23-\x5b\x5d-\x7e\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|\\[\x01-\x09\x0b\x0c\x0d-\x7f\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))*(([ \t]*\r\n)?[ \t]+)?")@(([a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|[a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF][a-z\d\-._~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]*[a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])\.)+([a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|[a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF][a-z\d\-._~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]*[a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])\.?$/i;
		return pattern.test(emailAddress);
	};
	
	var errorMessage = function(id, message){
		return jQuery('<span/>', {
			id: id,
			class: "mustFill",
			html: "<br/>" + message,
		})
	};
	
	function checkEmpty(obj){
		var name = obj[0].name;
		if($(obj[0]).attr("mustfill") == "false"){
			return true;
		}else if(name == "mail"){
			return true;
		}
		
		var value = obj.val().replace(/\s/g, "");
		var errSpanId = "err_" + obj[0].name;
		$('span#' + errSpanId).remove();
		if(value != "" && value != null){
			obj[0].style.borderColor = "";
			return true;
		}else{
			obj[0].style.borderColor = "red";
			if(obj[0].name != "players"){
				obj.after(errorMessage(errSpanId, "此欄位是必填欄位，不能留空! "));
			}else{
				$("span#newLine").after(errorMessage(errSpanId, "此欄位是必填欄位，不能留空!"));
			}
			return false;
		}
	}
	
	function checkEmail(obj){
		var name = obj[0].name;
		if(name != "mail"){
			return true;
		}
		
		if($(obj[0]).attr("mustfill") == "false" && obj.val().replace(/\s/g, "") == ""){
			return true;
		}
		
		var value = obj.val();
		$('span#mailError').remove();
		if(isValidEmailAddress(value)){
			obj[0].style.borderColor = "";
			return true;
		}else{
			obj[0].style.borderColor = "red";
			obj.after(errorMessage("mailError", "電子郵件格式不正確!"));
			return false;
		}
	}
	
	//將無意義自元統一換成一格空白
	function toMatchJson(stringIn){
		val = stringIn.replace(/\s/g, "");
		if(val == ""){
			return " ";
		}else{
			return stringIn;
		}
	}
	
	//檢查勾選同意條款
	$("input#agree").change(function() {
		if($(this).prop("checked")){
			$('button#submit').prop('disabled', false);
		}else{
			$('button#submit').prop('disabled', true);
		}
	});
	
	$('input[type=text], textarea, select[name|="group"]').on('input', function(){
		checkEmpty($(this));
	});
	
	$('input:checkbox[name|="attentedDate"]').change(function() {
		isCheckboxChecked();
	});
	
	$( "form#toPost" ).submit(function( event ) {
		event.preventDefault();
	});
	
	//下一步
	$("button#next").click(function(event){
		$("span#notfound").css("display", "none");
		var error = 0;
		$( "form#toPost" ).find('input[type=text]').each(function(){
			if(!checkEmail($(this))){
				error++;
			}
			if($(this)[0].name != "transferNUM" && !checkEmpty($(this))){
				error++;
			}
		});
		
		if(error == 0){
			$("p#nextFrame").fadeOut(100);
			$( "form#toPost" ).find('input[type=text]').each(function(){
				if($(this)[0].name != "transferNUM"){
					$(this).attr("disabled", true);
				}
			});
			
			////////////
			
			var dataObj = new Object();
			
			dataObj.id = $("input#id").val();
			$("span#show").fadeIn(100);
			
			$.get("https://script.google.com/macros/s/AKfycbyigFIcwBoIdIEKDJ6j61ra81xRJTzJPWeIqkZ-8PWoRp5JjeI/exec", 
				dataObj,
			function (result) {
				console.log(result);
				if(result == "false"){
					$("span#show").html("<p>系統發生錯誤，無法送出資料。請聯絡主辦單位! <a href='javascript:location.reload();'>重新整理</a></p>");
				}else if(result == "notfound"){
					$("span#notfound").css("display", "");
					$("span#show").fadeOut(100);
					$( "form#toPost" ).find('input[type=text]').each(function(){
						$(this).attr("disabled", false);
					});
					$("p#nextFrame").fadeIn(100);
				}else{
					var json = jQuery.parseJSON(result);
					console.log(json);
					$("td#signInId").text(json.id);
					$("td#teamName").text(json.teamName);
					
					$("span#show").fadeOut(100);
					$("span#transferNUMspan").fadeIn(500);
					$("span#show_info").fadeIn(500);
					$("span#startToPost").fadeIn(500);
					
					
				}
			});
		}
	});
	
	
	//送出
	$("button#submit").click(function(event){
		$("span#notfound").css("display", "none");
		var error = 0;
		$( "form#toPost" ).find('input[type=text], textarea, select[name|="group"]').each(function(){
			if(!checkEmail($(this))){
				error++;
			}
			if(!checkEmpty($(this))){
				error++;
			}
		});
		
	
		if(error == 0){
			var dataObj = new Object();
			
			dataObj.id = $("input#id").val();
			dataObj.transferNUM = $("input#transferNUM").val();
			
			//var data = JSON.stringify(dataObj);
			console.log(dataObj);
			
			$("div#cover").fadeOut( 500 , function() {
				$("span#show").fadeIn(100);
			});
			$.get("https://script.google.com/macros/s/AKfycbzVmHJK0GA4XqYy3myhZ8XjFSXA10myXqiwoUHJdaBUdHcitqc/exec", 
				dataObj,
			function (result) {
				console.log(result);
				if(result == "false"){
					$("span#show").html("<p>系統發生錯誤，無法送出資料。請聯絡主辦單位! <a href='javascript:location.reload();'>重新整理</a></p>");
				}else if(result == "notfound"){
					$("span#show").html("<p>系統發生錯誤，無法送出資料。請聯絡主辦單位! <a href='javascript:location.reload();'>重新整理</a></p>");
				}else{
					var json = jQuery.parseJSON(result);
					console.log(json);
					$("a#view").attr("href", json.url);
					$("a#download").attr("href", json.dlPDF);
					$("span#signInId").text(json.id);
					$("td#teamName").text(json.teamName);
					
					var status = json.status + "";
					
					if(status == "-1"){
						$("span#show").html("<p>系統發生錯誤。請聯絡主辦單位!</p>");
					}else if(status == "0"){
						$("span#show_success").fadeIn(500);
					}else if(status == "1"){
						$("span#show_done_before").fadeIn(500);
					}
					
					$("span#show").fadeOut(100);
					
				}
			});
		}
	
		return;
	});
</script>

</body>

</html>
